---
title: æ¨¡å‹ä¸€æœ¬æ­£ç»åœ°èƒ¡è¯´å…«é“ï¼ŸRAG å¦‚ä½•è®© LLM æœ‰æ®å¯æŸ¥
date: 2025-12-08 18:00:00
updated: {{current_date_time}}
categories:
  - ğŸ§  LLM/Agent ä»å…¥é—¨åˆ°ç²¾é€šï¼šå‘Šåˆ«æµ…å°è¾„æ­¢
  - AIä¸ç ”ç©¶
tags:
  - LLM
  - RAG
  - æ£€ç´¢å¢å¼ºç”Ÿæˆ
  - Embedding
  - Vector Database
  - Agent
keywords: LLM, RAG, æ£€ç´¢å¢å¼ºç”Ÿæˆ, Embedding, Vector Database, Chunking, Re-ranking, Query Transformation, çŸ¥è¯†å¢å¼ºç³»ç»Ÿ
description: 'æ·±å…¥è§£æ RAG æœºåˆ¶ï¼šä»ä¸‰é˜¶æ®µå·¥ä½œæµã€æ ¸å¿ƒç»„ä»¶åˆ°è¿›é˜¶ä¼˜åŒ–ç­–ç•¥ï¼Œæ„å»ºé«˜ç²¾åº¦ã€å¯è¿½æº¯çš„çŸ¥è¯†å¢å¼ºç³»ç»Ÿï¼Œçªç ´ LLM çš„çŸ¥è¯†æ—¶æ•ˆæ€§å’Œå¹»è§‰é—®é¢˜'
top_img: /img/llm-rag-deep-integration.png
cover: /img/llm-rag-deep-integration.png
comments: true
toc: true
toc_number: true
toc_style_simple: false
copyright: true
copyright_author: yuxiaoling
copyright_info: ç‰ˆæƒæ‰€æœ‰ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚
mathjax: false
katex: false
aplayer: false
highlight_shrink: false
aside: true
noticeOutdate: false
---

ä½ é—®æ¨¡å‹"å…¬å¸æœ€æ–°çš„æŠ¥é”€æ”¿ç­–æ˜¯ä»€ä¹ˆ"ï¼Œå®ƒç­”å¾—å¤´å¤´æ˜¯é“â€”â€”ä½†æ”¿ç­–ä¸Šä¸ªæœˆåˆšæ”¹ï¼Œå®ƒè¯´çš„å…¨æ˜¯é”™çš„ã€‚ä½ è®©å®ƒæ€»ç»“å†…éƒ¨æ–‡æ¡£ï¼Œå®ƒå´ç¼–é€ äº†æ ¹æœ¬ä¸å­˜åœ¨çš„æ¡æ¬¾ã€‚

**è¿™ä¸æ˜¯æ¨¡å‹"ç¬¨"ï¼Œæ˜¯å®ƒæ ¹æœ¬æ²¡æœ‰è®¿é—®è¿™äº›ä¿¡æ¯çš„é€šé“ã€‚**

RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰è§£å†³çš„å°±æ˜¯è¿™ä¸ªé—®é¢˜ï¼šåœ¨ç”Ÿæˆç­”æ¡ˆå‰ï¼Œå…ˆæ£€ç´¢ç›¸å…³æ–‡æ¡£ï¼Œè®©æ¨¡å‹**æœ‰æ®å¯æŸ¥**ã€‚çŸ¥è¯†æˆªæ­¢ã€å¹»è§‰ã€æ— æ³•è®¿é—®ç§æœ‰æ–‡æ¡£â€”â€”éƒ½å¯ä»¥é€šè¿‡ RAG ç¼“è§£ã€‚

æœ¬ç¯‡è§£æ RAG çš„ä¸‰é˜¶æ®µå·¥ä½œæµï¼ˆæ£€ç´¢ â†’ åˆ†å— â†’ é‡æ’ â†’ èåˆï¼‰ã€æ ¸å¿ƒç»„ä»¶å’Œè¿›é˜¶ä¼˜åŒ–ï¼Œå¸®ä½ æ„å»ºå¯è¿½æº¯çš„çŸ¥è¯†å¢å¼ºç³»ç»Ÿã€‚

---

## ğŸ“‹ ä¸€ã€RAG æ ¸å¿ƒæœºåˆ¶ï¼šä¸‰é˜¶æ®µå·¥ä½œæµ

RAG çš„æœ¬è´¨ï¼š**å…ˆæ£€ç´¢ï¼Œå†ç”Ÿæˆ**â€”â€”æŠŠ"çŒœ"å˜æˆ"æŸ¥"ã€‚

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ RAGï¼Ÿ

ä¼ä¸šå®¢æœè¦æŠŠå†…éƒ¨æ‰‹å†Œã€FAQ æ¥å…¥é—®ç­”ï¼›æ³•åŠ¡è¦åŸºäºåˆåŒæ¡æ¬¾ç”Ÿæˆæ‘˜è¦â€”â€”**çº¯ LLM æ— æ³•è®¿é—®ç§æœ‰æ–‡æ¡£**ï¼Œåªèƒ½"ççŒœ"ã€‚ä¼ ç»Ÿ LLM æœ‰ä¸‰é“åè¿‡ä¸å»ï¼š

| é—®é¢˜ | è¡¨ç° | å½±å“ |
|------|------|------|
| **çŸ¥è¯†æ—¶æ•ˆæ€§** | è®­ç»ƒæ•°æ®æˆªæ­¢åˆ°æŸä¸ªæ—¶é—´ç‚¹ | æ— æ³•å›ç­”æœ€æ–°äº‹ä»¶ã€æ”¿ç­–ã€æŠ€æœ¯ |
| **çŸ¥è¯†èŒƒå›´** | åªèƒ½ä½¿ç”¨è®­ç»ƒæ—¶çš„æ•°æ® | æ— æ³•è®¿é—®ä¼ä¸šç§æœ‰æ–‡æ¡£ã€å†…éƒ¨çŸ¥è¯†åº“ |
| **å¹»è§‰é—®é¢˜** | å¯èƒ½ç¼–é€ çœ‹ä¼¼åˆç†ä½†é”™è¯¯çš„ä¿¡æ¯ | ç­”æ¡ˆä¸å¯ä¿¡ï¼Œæ— æ³•éªŒè¯æ¥æº |
| **ä¸Šä¸‹æ–‡é™åˆ¶** | Context Window æœ‰é™ | æ— æ³•å¤„ç†è¶…é•¿æ–‡æ¡£æˆ–å¤§é‡çŸ¥è¯† |

**RAG çš„è§£å†³æ–¹æ¡ˆ**ï¼š

> å°†å¤–éƒ¨çŸ¥è¯†åº“ä¸ LLM ç»“åˆï¼Œè®©æ¨¡å‹åœ¨ç”Ÿæˆç­”æ¡ˆå‰å…ˆæ£€ç´¢ç›¸å…³æ–‡æ¡£ï¼Œç„¶ååŸºäºæ£€ç´¢åˆ°çš„å†…å®¹ç”Ÿæˆç­”æ¡ˆã€‚

è¿™æ ·æ—¢ä¿è¯äº†ç­”æ¡ˆçš„å‡†ç¡®æ€§ï¼ˆæœ‰æ®å¯æŸ¥ï¼‰ï¼Œåˆçªç ´äº†çŸ¥è¯†æ—¶æ•ˆæ€§å’ŒèŒƒå›´çš„é™åˆ¶ã€‚

### 1.2 RAG çš„ä¸‰é˜¶æ®µå·¥ä½œæµ

RAG çš„å·¥ä½œæµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

| é˜¶æ®µ                      | æ ¸å¿ƒä»»åŠ¡                 | æœºåˆ¶æ¦‚è¿°                                 | æ ¸å¿ƒæŒ‘æˆ˜                  |
| :---------------------- | :------------------- | :----------------------------------- | :-------------------- |
| **1. æ£€ç´¢ï¼ˆRetrievalï¼‰**    | åœ¨æµ·é‡æ–‡æ¡£ä¸­å®šä½ä¸ç”¨æˆ·æŸ¥è¯¢è¯­ä¹‰ç›¸å…³çš„ç‰‡æ®µ | ä½¿ç”¨ **Embedding Model** å°†æ–‡æœ¬è½¬å‘é‡å¹¶è¿›è¡Œå‘é‡æœç´¢ | **å¬å›ç‡ä½**ï¼šå¯èƒ½æ¼æ‰é‡è¦ä¿¡æ¯     |
| **2. å¢å¼ºï¼ˆAugmentationï¼‰** | å°†æ£€ç´¢åˆ°çš„ç‰‡æ®µæ³¨å…¥ LLM Prompt | Prompt é‡æ„ï¼Œå°†ä¸Šä¸‹æ–‡ä½œä¸ºå‚è€ƒèµ„æ–™                 | **ä¸Šä¸‹æ–‡æ±¡æŸ“**ï¼šæ— å…³ä¿¡æ¯å¯èƒ½è¯¯å¯¼æ¨¡å‹  |
| **3. ç”Ÿæˆï¼ˆGenerationï¼‰**   | LLM åŸºäºæ³¨å…¥çš„ä¸Šä¸‹æ–‡ç”Ÿæˆç­”æ¡ˆ     | æ¡ä»¶ç”Ÿæˆï¼Œç»“åˆ Schema æˆ– Prompt çº¦æŸ           | **æ•´åˆèƒ½åŠ›**ï¼šç»¼åˆå¤šä¸ªç‰‡æ®µå‡†ç¡®ç”Ÿæˆç­”æ¡ˆ |

**å®Œæ•´æµç¨‹ç¤ºä¾‹**ï¼š

```python
# RAG ä¸‰é˜¶æ®µæµç¨‹ï¼ˆä¼ªä»£ç ï¼‰

# é˜¶æ®µ1ï¼šæ£€ç´¢ï¼ˆRetrievalï¼‰
user_query = "ç”¨æˆ·ç™»å½•åŠŸèƒ½å¦‚ä½•å®ç°ï¼Ÿ"
query_embedding = embed_model.encode(user_query)
relevant_chunks = vector_db.search(query_embedding, top_k=5)
# è¾“å‡ºï¼š5ä¸ªç›¸å…³çš„æ–‡æ¡£ç‰‡æ®µ

# é˜¶æ®µ2ï¼šå¢å¼ºï¼ˆAugmentationï¼‰
context = "\n\n".join([chunk.text for chunk in relevant_chunks])
prompt = f"""
åŸºäºä»¥ä¸‹æ–‡æ¡£å†…å®¹ï¼Œå›ç­”ç”¨æˆ·é—®é¢˜ï¼š

æ–‡æ¡£å†…å®¹ï¼š
{context}

ç”¨æˆ·é—®é¢˜ï¼š{user_query}

è¯·åŸºäºæ–‡æ¡£å†…å®¹å›ç­”ï¼Œå¦‚æœæ–‡æ¡£ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·è¯´æ˜"æ–‡æ¡£ä¸­æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯"ã€‚
"""

# é˜¶æ®µ3ï¼šç”Ÿæˆï¼ˆGenerationï¼‰
answer = llm.generate(prompt)
# è¾“å‡ºï¼šåŸºäºæ£€ç´¢åˆ°çš„æ–‡æ¡£ç”Ÿæˆçš„ç­”æ¡ˆ
```

### 1.3 RAG çš„ä¼˜åŠ¿å¯¹æ¯” Fine-Tuning

åœ¨[ç¬¬2ç¯‡](/2025-12-03-llm-prompt-context-in-context-learning/#33-fine-tuningå¾®è°ƒè¯¦è§£)ä¸­ï¼Œæˆ‘ä»¬è¯¦ç»†è®²è§£äº† Fine-Tuningï¼ˆå¾®è°ƒï¼‰ã€‚è¿™é‡Œæˆ‘ä»¬å¯¹æ¯” RAG å’Œ Fine-Tuningï¼Œå¸®åŠ©ä½ é€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ–¹æ¡ˆï¼š

| ç»´åº¦ | RAG | Fine-Tuning | è¯´æ˜ |
|------|-----|-------------|------|
| **çŸ¥è¯†æ›´æ–°** | å®æ—¶/é«˜æ•ˆï¼šæ›´æ–°çŸ¥è¯†åº“å³å¯ | æ»å/é«˜æˆæœ¬ï¼šéœ€é‡æ–°è®­ç»ƒæ¨¡å‹ | RAG åªéœ€æ›´æ–°å‘é‡æ•°æ®åº“ï¼ŒFine-Tuning éœ€è¦é‡æ–°è®­ç»ƒ |
| **çŸ¥è¯†æ¥æº** | å¤–éƒ¨/å¯è¿½æº¯ï¼šç­”æ¡ˆå¯é“¾æ¥åŸå§‹æ–‡æ¡£ | å†…éƒ¨/ä¸å¯è§ï¼šçŸ¥è¯†èå…¥æ¨¡å‹å‚æ•° | RAG å¯ä»¥è¿½æº¯ç­”æ¡ˆæ¥æºï¼ŒFine-Tuning æ— æ³•è¿½æº¯ |
| **çŸ¥è¯†èŒƒå›´** | å¯è®¿é—®æµ·é‡å¤–éƒ¨æ–‡æ¡£ | å—è®­ç»ƒæ•°æ®é™åˆ¶ | RAG å¯ä»¥è®¿é—®ä»»æ„æ–‡æ¡£ï¼ŒFine-Tuning åªèƒ½ä½¿ç”¨è®­ç»ƒæ•°æ® |
| **æˆæœ¬** | ä½ï¼šä¸»è¦æ˜¯å­˜å‚¨å’Œæ£€ç´¢æˆæœ¬ | é«˜ï¼šéœ€è¦ GPU è®­ç»ƒ | RAG æˆæœ¬ä½ï¼ŒFine-Tuning æˆæœ¬é«˜ |
| **é€‚ç”¨åœºæ™¯** | å¿«é€Ÿå˜åŒ–çš„é¢†åŸŸã€è®¿é—®æµ·é‡ç§æœ‰æ•°æ®ã€éœ€è¦å¯è¿½æº¯ç­”æ¡ˆ | æ”¹å˜æ¨¡å‹é£æ ¼ã€æ ¼å¼æˆ–è¯­æ°”ã€é¢†åŸŸç‰¹å®šä»»åŠ¡ | åœºæ™¯ä¸åŒï¼Œé€‰æ‹©ä¸åŒ |

**å†³ç­–æŒ‡å—**ï¼š

| éœ€æ±‚ | æ¨èæ–¹æ¡ˆ | åŸå›  |
|------|---------|------|
| éœ€è¦è®¿é—®æœ€æ–°ä¿¡æ¯ | RAG | å¯ä»¥å®æ—¶æ›´æ–°çŸ¥è¯†åº“ |
| éœ€è¦è®¿é—®ä¼ä¸šç§æœ‰æ–‡æ¡£ | RAG | å¯ä»¥è®¿é—®ä»»æ„å¤–éƒ¨æ–‡æ¡£ |
| éœ€è¦å¯è¿½æº¯çš„ç­”æ¡ˆ | RAG | ç­”æ¡ˆå¯ä»¥é“¾æ¥åˆ°åŸå§‹æ–‡æ¡£ |
| éœ€è¦æ”¹å˜æ¨¡å‹è¾“å‡ºé£æ ¼ | Fine-Tuning | å¯ä»¥è®­ç»ƒæ¨¡å‹æ”¹å˜é£æ ¼ |
| éœ€è¦é¢†åŸŸç‰¹å®šèƒ½åŠ› | Fine-Tuning | å¯ä»¥é€šè¿‡è®­ç»ƒæå‡é¢†åŸŸèƒ½åŠ› |
| éœ€è¦å¿«é€Ÿä¸Šçº¿ | RAG | å®ç°ç®€å•ï¼Œæˆæœ¬ä½ |
| éœ€è¦é•¿æœŸç¨³å®šä½¿ç”¨ | Fine-Tuning | è®­ç»ƒåæ¨¡å‹è¡Œä¸ºç¨³å®š |

> ğŸ’¡ **æ ¸å¿ƒç†è§£**ï¼š
> * **RAG** æ›´é€‚åˆ"çŸ¥è¯†åŠ¨æ€æ›´æ–° + é«˜å¯ä¿¡åº¦ + å¯è¿½æº¯"çš„åœºæ™¯
> * **Fine-Tuning** æ›´é€‚åˆ"é£æ ¼ä¸æ ¼å¼è°ƒæ•´ + é¢†åŸŸç‰¹å®šèƒ½åŠ›"çš„åœºæ™¯
> * **ä¸¤è€…å¯ä»¥ç»“åˆ**ï¼šFine-Tuning åçš„æ¨¡å‹ä»å¯ä½¿ç”¨ RAG è®¿é—®å¤–éƒ¨çŸ¥è¯†
> * **Agent åœºæ™¯ä¸‹çš„å¾®è°ƒå®è·µ**ï¼ˆLoRAã€PEFTï¼‰è¯¦è§[ç¬¬ 16 ç¯‡èƒ½åŠ›è°ƒä¼˜](/2026-01-02-llm-agent-capability-tuning/)

---

## ğŸ§± äºŒã€åŸºç¡€ç»„ä»¶æ·±åº¦è§£æï¼šæ„å»ºçŸ¥è¯†åº“

ä¸€ä¸ªé«˜æ•ˆçš„ RAG ç³»ç»Ÿä¾èµ–ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š**Chunkingã€Embeddingã€Vector Database**ã€‚

è¿™ä¸‰ä¸ªç»„ä»¶æ„æˆäº† RAG ç³»ç»Ÿçš„"åŸºç¡€è®¾æ–½"ï¼Œç†è§£å®ƒä»¬çš„å·¥ä½œåŸç†æ˜¯æ„å»ºé«˜è´¨é‡ RAG ç³»ç»Ÿçš„å‰æã€‚

### 2.1 Chunkingï¼ˆåˆ†å—ï¼‰ï¼šè¯­ä¹‰å®Œæ•´æ€§çš„è‰ºæœ¯

ä½ æœ‰ä¸€ä»½ 100 é¡µçš„æŠ€æœ¯æ‰‹å†Œè¦åšæˆçŸ¥è¯†åº“ã€‚ç”¨æˆ·é—®"ç™»å½•åŠŸèƒ½æ€ä¹ˆå®ç°ï¼Ÿ"â€”â€”**åˆ†å—æ–¹å¼å†³å®šäº†èƒ½å¬å›å“ªäº›å†…å®¹**ã€‚åˆ‡å¾—å¤ªç¢ï¼Œè¯­ä¹‰æ–­è£‚ï¼›åˆ‡å¾—å¤ªå¤§ï¼Œå™ªéŸ³å¤ªå¤šã€‚

**å®šä¹‰**ï¼šå°†å¤§å‹æ–‡æ¡£æ‹†æˆé€‚åˆæ£€ç´¢å’Œ Context Window çš„å°ç‰‡æ®µï¼ˆChunkï¼‰ã€‚**å…³é”®åŸåˆ™**ï¼šæ¯ä¸ª Chunk è¯­ä¹‰å®Œæ•´ï¼Œå¦åˆ™æ¨¡å‹æ”¶åˆ°çš„ä¿¡æ¯ä¼šæ–­è£‚ã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦åˆ†å—ï¼Ÿ

* **Context Window é™åˆ¶**ï¼šLLM çš„ä¸Šä¸‹æ–‡çª—å£æœ‰é™ï¼ˆå¦‚ GPT-4 æ˜¯ 128k Tokenï¼‰ï¼Œæ— æ³•ä¸€æ¬¡æ€§å¤„ç†æ•´æœ¬ä¹¦
* **æ£€ç´¢ç²¾åº¦**ï¼šå°ç‰‡æ®µæ›´å®¹æ˜“ç²¾ç¡®åŒ¹é…ç”¨æˆ·æŸ¥è¯¢
* **è®¡ç®—æ•ˆç‡**ï¼šå¤„ç†å°ç‰‡æ®µæ¯”å¤„ç†æ•´ä¸ªæ–‡æ¡£æ›´é«˜æ•ˆ

#### å¸¸ç”¨åˆ†å—ç­–ç•¥

**1. å›ºå®šå¤§å°åˆ†å—ï¼ˆFixed Size Chunkingï¼‰**

* **æ–¹æ³•**ï¼šæŒ‰å›ºå®šå­—ç¬¦æ•°æˆ– Token æ•°åˆ‡åˆ†ï¼ˆå¦‚æ¯ 500 å­—ç¬¦ä¸€æ®µï¼‰
* **ä¼˜ç‚¹**ï¼šç®€å•æ˜“ç”¨ï¼Œå®ç°æˆæœ¬ä½
* **ç¼ºç‚¹**ï¼šå®¹æ˜“åˆ‡æ–­å¥å­ï¼Œç ´åè¯­ä¹‰å®Œæ•´æ€§

**ç¤ºä¾‹**ï¼š
```python
# å›ºå®šå¤§å°åˆ†å—ï¼ˆä¼ªä»£ç ï¼‰
chunks = []
chunk_size = 500  # å­—ç¬¦æ•°
for i in range(0, len(document), chunk_size):
    chunk = document[i:i+chunk_size]
    chunks.append(chunk)
```

**2. è¯­ä¹‰åˆ†å—ï¼ˆSemantic Chunkingï¼‰**

**æ–¹æ³•**ï¼šä¸æ˜¯æœºæ¢°åœ°æŒ‰å›ºå®šå¤§å°åˆ‡åˆ†ï¼Œè€Œæ˜¯**æŒ‰ç…§æ–‡æ¡£çš„è‡ªç„¶ç»“æ„**ï¼ˆæ ‡é¢˜ã€æ®µè½ã€å¥å­è¾¹ç•Œï¼‰æˆ–ä½¿ç”¨ NLP æŠ€æœ¯è¯†åˆ«è¯­ä¹‰è¾¹ç•Œï¼Œä¿è¯æ¯ä¸ª Chunk åŒ…å«å®Œæ•´ä¸»é¢˜ã€‚

**å…·ä½“åšæ³•**ï¼š
* **åŸºäºæ®µè½**ï¼šæŒ‰æ®µè½ï¼ˆ`\n\n`ï¼‰åˆ†å‰²ï¼Œæ¯ä¸ªæ®µè½ä½œä¸ºä¸€ä¸ª Chunk
* **åŸºäºæ ‡é¢˜**ï¼šè¯†åˆ«æ–‡æ¡£ä¸­çš„æ ‡é¢˜ï¼ˆå¦‚ `# æ ‡é¢˜`ï¼‰ï¼Œæ¯ä¸ªæ ‡é¢˜ä¸‹çš„å†…å®¹ä½œä¸ºä¸€ä¸ª Chunk
* **åŸºäºå¥å­è¾¹ç•Œ**ï¼šåœ¨æ®µè½å†…æŒ‰å¥å­ï¼ˆ`ã€‚`ã€`.`ï¼‰åˆ†å‰²ï¼Œç»„åˆå¥å­ç›´åˆ°è¾¾åˆ°åˆé€‚å¤§å°
* **åŸºäº NLP æŠ€æœ¯**ï¼šä½¿ç”¨è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—ï¼Œæ‰¾åˆ°è¯­ä¹‰è¾¹ç•Œï¼ˆå¦‚ LangChain çš„ `SemanticChunker`ï¼‰

**ä¼˜ç‚¹**ï¼šä¿æŒè¯­ä¹‰å®Œæ•´æ€§ï¼Œæ£€ç´¢æ›´å‡†ç¡®

**ç¼ºç‚¹**ï¼šå®ç°å¤æ‚ï¼Œéœ€è¦ç†è§£æ–‡æ¡£ç»“æ„

**ç¤ºä¾‹**ï¼š
```python
# è¯­ä¹‰åˆ†å—ï¼ˆä¼ªä»£ç ï¼‰

# æ–¹æ³•1ï¼šåŸºäºæ®µè½åˆ†å—
paragraphs = document.split('\n\n')  # æŒ‰æ®µè½åˆ†å‰²
chunks = []
for para in paragraphs:
    if len(para) > 500:  # æ®µè½å¤ªé•¿ï¼Œç»§ç»­åˆ†å‰²
        # æŒ‰å¥å­åˆ†å‰²
        sentences = para.split('ã€‚')
        # ç»„åˆå¥å­ç›´åˆ°è¾¾åˆ°åˆé€‚å¤§å°
        current_chunk = ""
        for sentence in sentences:
            if len(current_chunk + sentence) < 500:
                current_chunk += sentence
            else:
                chunks.append(current_chunk)
                current_chunk = sentence
    else:
        chunks.append(para)

# æ–¹æ³•2ï¼šåŸºäºæ ‡é¢˜åˆ†å—ï¼ˆMarkdown æ–‡æ¡£ï¼‰
import re
# è¯†åˆ« Markdown æ ‡é¢˜ï¼ˆå¦‚ # æ ‡é¢˜ã€## å­æ ‡é¢˜ï¼‰
headings = re.findall(r'^#+\s+(.+)$', document, re.MULTILINE)
# æŒ‰æ ‡é¢˜åˆ†å‰²æ–‡æ¡£
for heading in headings:
    # æå–è¯¥æ ‡é¢˜ä¸‹çš„å†…å®¹ä½œä¸ºä¸€ä¸ª Chunk
    chunk = extract_content_under_heading(document, heading)
    chunks.append(chunk)

# æ–¹æ³•3ï¼šåŸºäº NLP è¯­ä¹‰ç›¸ä¼¼åº¦ï¼ˆä½¿ç”¨ LangChainï¼‰
from langchain.text_splitter import SemanticChunker
splitter = SemanticChunker()
chunks = splitter.create_documents([document])
```

**3. çˆ¶æ–‡æ¡£/å­æ–‡æ¡£ç­–ç•¥ï¼ˆParent-Document RAGï¼‰**

* **æ–¹æ³•**ï¼šæ£€ç´¢å°è€Œç²¾å‡†çš„å­ Chunkï¼Œå¢å¼ºé˜¶æ®µæ³¨å…¥æ•´ä¸ªçˆ¶ Chunkï¼Œç¡®ä¿ä¸Šä¸‹æ–‡å®Œæ•´
* **ä¼˜ç‚¹**ï¼šå…¼é¡¾æ£€ç´¢ç²¾åº¦å’Œä¸Šä¸‹æ–‡å®Œæ•´æ€§
* **é€‚ç”¨åœºæ™¯**ï¼šæ–‡æ¡£ç»“æ„æ¸…æ™°ï¼Œæœ‰æ˜ç¡®çš„çˆ¶å­å…³ç³»

**ç¤ºä¾‹**ï¼š
```python
# çˆ¶æ–‡æ¡£/å­æ–‡æ¡£ç­–ç•¥ï¼ˆä¼ªä»£ç ï¼‰
# ç¬¬ä¸€å±‚ï¼šå¤§å—ï¼ˆçˆ¶æ–‡æ¡£ï¼‰
parent_chunks = split_by_section(document)  # æŒ‰ç« èŠ‚åˆ†å‰²

# ç¬¬äºŒå±‚ï¼šå°å—ï¼ˆå­æ–‡æ¡£ï¼‰
child_chunks = []
for parent in parent_chunks:
    children = split_by_paragraph(parent)  # æŒ‰æ®µè½åˆ†å‰²
    child_chunks.extend(children)
    # è®°å½•çˆ¶å­å…³ç³»
    for child in children:
        child.parent = parent

# æ£€ç´¢æ—¶ï¼šç”¨å­ Chunk æ£€ç´¢ï¼ˆç²¾ç¡®ï¼‰
# å¢å¼ºæ—¶ï¼šç”¨çˆ¶ Chunk å¢å¼ºï¼ˆå®Œæ•´ä¸Šä¸‹æ–‡ï¼‰
```

> ğŸ“ **æ¯”å–»ç†è§£**ï¼šChunk å°±åƒ"çŸ¥è¯†ç –å—"ï¼Œåˆ†å—æ–¹å¼å†³å®šäº†æ¨¡å‹æ­å»ºçŸ¥è¯†å¤§å¦çš„ç¨³å®šæ€§ã€‚
> * å›ºå®šå¤§å° = æœºæ¢°åˆ‡å‰²ï¼Œå¯èƒ½åˆ‡åç –å—
> * è¯­ä¹‰åˆ†å— = æŒ‰çº¹ç†åˆ‡å‰²ï¼Œä¿æŒç –å—å®Œæ•´
> * çˆ¶æ–‡æ¡£ç­–ç•¥ = å°ç –å—å®šä½ï¼Œå¤§ç –å—ä½¿ç”¨

### 2.2 Embedding Modelï¼ˆåµŒå…¥æ¨¡å‹ï¼‰ï¼šè¯­è¨€çš„æ•°å­—æŒ‡çº¹

**å®šä¹‰**ï¼šå°†æ–‡æœ¬ Chunk è½¬æ¢ä¸ºé«˜ç»´å‘é‡ï¼ˆEmbeddingï¼‰çš„æ¨¡å‹ã€‚

**åŠŸèƒ½**ï¼šè¯­ä¹‰ç›¸ä¼¼çš„ Chunk åœ¨å‘é‡ç©ºé—´è·ç¦»æ›´è¿‘ï¼Œä½¿å¾—å‘é‡æœç´¢èƒ½å¤Ÿæ‰¾åˆ°è¯­ä¹‰ç›¸å…³çš„å†…å®¹ã€‚

#### Embedding çš„å·¥ä½œåŸç†

[ç¬¬1ç¯‡](/2025-12-02-llm-working-principle-token-embedding-transformer/)è®²è¿‡ Token Embeddingï¼ˆè¯â†’å‘é‡ï¼‰ã€‚RAG ç”¨çš„æ˜¯ **Text Embedding**ï¼šæŠŠæ•´ä¸ª Chunkï¼ˆå¥å­ã€æ®µè½ï¼‰è½¬æˆä¸€ä¸ªå›ºå®šç»´åº¦çš„å‘é‡ã€‚è¯­ä¹‰ç›¸è¿‘çš„ Chunk åœ¨å‘é‡ç©ºé—´é‡Œè·ç¦»æ›´è¿‘ï¼Œæ£€ç´¢æ—¶å°±èƒ½"æŒ‰è¯­ä¹‰æ‰¾é‚»å±…"ã€‚

**ç¤ºä¾‹**ï¼š
```python
# Embedding ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰
from sentence_transformers import SentenceTransformer

# åŠ è½½ Embedding æ¨¡å‹
model = SentenceTransformer('all-MiniLM-L6-v2')

# å°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡
text = "ç”¨æˆ·ç™»å½•åŠŸèƒ½éœ€è¦éªŒè¯ç”¨æˆ·åå’Œå¯†ç "
embedding = model.encode(text)
# è¾“å‡ºï¼šä¸€ä¸ª 384 ç»´çš„å‘é‡ï¼Œå¦‚ [0.1, -0.3, 0.5, ...]
```

#### é€‰å‹åŸåˆ™

| è€ƒè™‘å› ç´  | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|
| **è¯­è¨€åŒ¹é…** | ä¸­æ–‡çŸ¥è¯†åº“ç”¨ä¸­æ–‡ Embedding æ¨¡å‹ | `text2vec-chinese`ã€`m3e-base` |
| **é¢†åŸŸåŒ¹é…** | ä¸“ä¸šé¢†åŸŸç”¨é¢†åŸŸæ¨¡å‹ | åŒ»å­¦é¢†åŸŸç”¨åŒ»å­¦ Embedding æ¨¡å‹ |
| **ç»´åº¦å¹³è¡¡** | ç»´åº¦è¶Šé«˜ç²¾åº¦è¶Šå¥½ï¼Œä½†è®¡ç®—æˆæœ¬è¶Šé«˜ | 768 ç»´ vs 1536 ç»´ |
| **æ¨¡å‹å¤§å°** | å¤§æ¨¡å‹æ•ˆæœå¥½ä½†æ¨ç†æ…¢ | å°æ¨¡å‹é€Ÿåº¦å¿«ä½†ç²¾åº¦ç•¥ä½ |

> ğŸ’¡ **å®æˆ˜æç¤º**ï¼š
> * **ä¸­æ–‡åœºæ™¯**ï¼šæ¨è `text2vec-chinese`ã€`m3e-base`
> * **å¤šè¯­è¨€åœºæ™¯**ï¼šæ¨è `multilingual-e5-base`
> * **è‹±æ–‡åœºæ™¯**ï¼šæ¨è `all-MiniLM-L6-v2`ã€`text-embedding-ada-002`

### 2.3 Vector Databaseï¼ˆå‘é‡æ•°æ®åº“ï¼‰ï¼šé«˜æ•ˆæ£€ç´¢æ ¸å¿ƒ

**å®šä¹‰**ï¼šå­˜å‚¨ä¸ç®¡ç†æ‰€æœ‰ Chunk å‘é‡çš„æ•°æ®åº“ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼šå½“ç”¨æˆ·æŸ¥è¯¢å‘é‡è¾“å…¥æ—¶ï¼Œé€šè¿‡ **ANNï¼ˆApproximate Nearest Neighborï¼Œè¿‘ä¼¼æœ€è¿‘é‚»ï¼‰** æœç´¢å¿«é€Ÿè¿”å› Top K ç›¸å…³ Chunkã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦å‘é‡æ•°æ®åº“ï¼Ÿ

ä¼ ç»Ÿæ•°æ®åº“æ— æ³•é«˜æ•ˆå¤„ç†å‘é‡ç›¸ä¼¼åº¦æœç´¢ã€‚å‘é‡æ•°æ®åº“ä¸“é—¨ä¼˜åŒ–äº†å‘é‡æ£€ç´¢ï¼Œèƒ½å¤Ÿåœ¨ç™¾ä¸‡çº§ç”šè‡³åƒä¸‡çº§å‘é‡ä¸­å¿«é€Ÿæ‰¾åˆ°æœ€ç›¸ä¼¼çš„ Top K ä¸ªç»“æœã€‚

#### å…³é”®æŠ€æœ¯ï¼šHNSW ç´¢å¼•

**HNSWï¼ˆHierarchical Navigable Small Worldï¼‰** æ˜¯å‘é‡æ•°æ®åº“å¸¸ç”¨çš„ç´¢å¼•ç®—æ³•ï¼š

* **åŸç†**ï¼šæ„å»ºå¤šå±‚å›¾ç»“æ„ï¼Œä»ç²—åˆ°ç»†é€å±‚æœç´¢
* **ä¼˜åŠ¿**ï¼šæ£€ç´¢é€Ÿåº¦å¿«ï¼ˆO(log n)ï¼‰ï¼Œç²¾åº¦é«˜
* **é€‚ç”¨åœºæ™¯**ï¼šå¤§è§„æ¨¡å‘é‡æ£€ç´¢ï¼ˆç™¾ä¸‡çº§ä»¥ä¸Šï¼‰

**ç®€å•ç†è§£**ï¼š
> å°±åƒåœ°å›¾å¯¼èˆªï¼šå…ˆçœ‹å›½å®¶åœ°å›¾æ‰¾åˆ°å¤§è‡´åŒºåŸŸï¼Œå†çœ‹åŸå¸‚åœ°å›¾æ‰¾åˆ°å…·ä½“ä½ç½®ï¼Œæœ€åçœ‹è¡—é“åœ°å›¾æ‰¾åˆ°ç²¾ç¡®åœ°å€ã€‚

#### å¸¸è§å‘é‡æ•°æ®åº“å¯¹æ¯”

| æ•°æ®åº“ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|--------|------|---------|
| **Pinecone** | äº‘æœåŠ¡ï¼Œæ˜“ç”¨ï¼Œæ€§èƒ½å¥½ | å¿«é€ŸåŸå‹ã€ä¸­å°è§„æ¨¡é¡¹ç›® |
| **Weaviate** | å¼€æºï¼ŒåŠŸèƒ½ä¸°å¯Œï¼Œæ”¯æŒå¤šæ¨¡æ€ | ä¸­å¤§è§„æ¨¡é¡¹ç›®ï¼Œéœ€è¦å¤æ‚æŸ¥è¯¢ |
| **Milvus** | å¼€æºï¼Œæ€§èƒ½å¼ºï¼Œå¯æ‰©å±• | å¤§è§„æ¨¡é¡¹ç›®ï¼Œéœ€è¦è‡ªéƒ¨ç½² |
| **Qdrant** | å¼€æºï¼ŒRust å®ç°ï¼Œæ€§èƒ½å¥½ | å¯¹æ€§èƒ½è¦æ±‚é«˜çš„é¡¹ç›® |
| **Chroma** | è½»é‡çº§ï¼Œæ˜“é›†æˆ | å°è§„æ¨¡é¡¹ç›®ï¼Œå¿«é€Ÿå¼€å‘ |

> ğŸ”¹ **å®æˆ˜æç¤º**ï¼š
> * **å¿«é€ŸåŸå‹**ï¼šä½¿ç”¨ Pinecone æˆ– Chroma
> * **ç”Ÿäº§ç¯å¢ƒ**ï¼šæ ¹æ®è§„æ¨¡é€‰æ‹© Milvus æˆ– Weaviate
> * **å…³é”®è¦æ±‚**ï¼šæ”¯æŒåŠ¨æ€æ›´æ–°ï¼ˆæ–°å¢æ–‡æ¡£ï¼‰ã€é«˜å¹¶å‘æŸ¥è¯¢ã€æŒä¹…åŒ–å­˜å‚¨

---

## ğŸš€ ä¸‰ã€è¿›é˜¶ä¼˜åŒ–ç­–ç•¥ï¼šæ‰“é€ é«˜ç²¾åº¦ RAG

åŸºç¡€ RAG å®¹æ˜“å‡ºç° **ä½å¬å›ç‡**ï¼ˆæ¼æ‰é‡è¦ä¿¡æ¯ï¼‰å’Œ **ä¸Šä¸‹æ–‡æ±¡æŸ“**ï¼ˆæ— å…³ä¿¡æ¯è¯¯å¯¼æ¨¡å‹ï¼‰ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦è¿›é˜¶ç­–ç•¥ã€‚

### åŸºç¡€ RAG çš„é—®é¢˜

| é—®é¢˜ | è¡¨ç° | åŸå›  |
|------|------|------|
| **ä½å¬å›ç‡** | æ£€ç´¢ä¸åˆ°ç›¸å…³æ–‡æ¡£ | æŸ¥è¯¢ä¸æ–‡æ¡£çš„è¯­ä¹‰ä¸åŒ¹é… |
| **ä½ç²¾ç¡®ç‡** | æ£€ç´¢åˆ°ä¸ç›¸å…³æ–‡æ¡£ | å‘é‡æœç´¢åªè€ƒè™‘ç›¸ä¼¼åº¦ï¼Œä¸è€ƒè™‘å®é™…ç›¸å…³æ€§ |
| **ä¸Šä¸‹æ–‡æ±¡æŸ“** | æ£€ç´¢åˆ°çš„æ–‡æ¡£åŒ…å«æ— å…³ä¿¡æ¯ | æ²¡æœ‰å¯¹æ£€ç´¢ç»“æœè¿›è¡Œç­›é€‰å’Œæ’åº |
| **å•è½®é™åˆ¶** | æ— æ³•å¤„ç†å¤šæ­¥éª¤æ¨ç† | ä¸€æ¬¡æ£€ç´¢æ— æ³•å›ç­”å¤æ‚é—®é¢˜ |

### 3.1 Re-rankingï¼ˆé‡æ’ï¼‰ï¼šæå‡ç²¾ç¡®ç‡

ç”¨æˆ·é—®"ç™»å½•å¤±è´¥æ€ä¹ˆåŠ"ï¼Œå‘é‡æ£€ç´¢å¯èƒ½å¬å›"ç™»å½•åŠŸèƒ½è¯´æ˜"ã€"ç™»å½•æŒ‰é’®è®¾è®¡"â€”â€”**è¯­ä¹‰ç›¸è¿‘ï¼Œä½†ç”¨æˆ·è¦çš„æ˜¯æ•…éšœæ’æŸ¥**ã€‚

**Re-ranking** ç”¨ Cross-Encoder å¯¹ Top N ç»“æœäºŒæ¬¡æ’åºï¼ŒåŒæ—¶è€ƒè™‘**æŸ¥è¯¢ + æ–‡æ¡£**çš„äº¤äº’ï¼Œç­›æ‰"çœ‹ä¼¼ç›¸å…³å®åˆ™ä¸ç›¸å…³"çš„ç‰‡æ®µã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦ Re-rankingï¼Ÿ

å‘é‡æ£€ç´¢æ˜¯"å•å‘"çš„ï¼šåªçœ‹æ–‡æ¡£è¯­ä¹‰ï¼Œä¸çœ‹æŸ¥è¯¢æ„å›¾ã€‚Re-ranking åš"åŒå‘"åˆ¤æ–­ï¼Œèƒ½è¯†åˆ«"ç™»å½•å¤±è´¥"å’Œ"ç™»å½•åŠŸèƒ½"çš„å·®åˆ«ã€‚

#### å·¥ä½œåŸç†

```python
# Re-ranking æµç¨‹ï¼ˆä¼ªä»£ç ï¼‰

# ç¬¬ä¸€æ­¥ï¼šå‘é‡æ£€ç´¢ï¼ˆå¿«é€Ÿï¼Œä½†ä¸å¤Ÿç²¾ç¡®ï¼‰
query_embedding = embed_model.encode(user_query)
top_n_chunks = vector_db.search(query_embedding, top_k=20)  # æ£€ç´¢ Top 20

# ç¬¬äºŒæ­¥ï¼šRe-rankingï¼ˆæ…¢ï¼Œä½†ç²¾ç¡®ï¼‰
reranker = CrossEncoder('cross-encoder/ms-marco-MiniLM-L-6-v2')
scores = []
for chunk in top_n_chunks:
    # è®¡ç®—æŸ¥è¯¢å’Œæ–‡æ¡£çš„äº¤äº’å¾—åˆ†
    score = reranker.predict([user_query, chunk.text])
    scores.append((score, chunk))

# ç¬¬ä¸‰æ­¥ï¼šæŒ‰å¾—åˆ†æ’åºï¼Œå– Top K
top_k_chunks = sorted(scores, reverse=True)[:5]  # å– Top 5
```

**æ•ˆæœå¯¹æ¯”**ï¼š

| æ–¹æ³• | ç²¾ç¡®ç‡ | é€Ÿåº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|---------|
| **ä»…å‘é‡æ£€ç´¢** | ä¸­ç­‰ | å¿« | å¯¹ç²¾åº¦è¦æ±‚ä¸é«˜çš„åœºæ™¯ |
| **å‘é‡æ£€ç´¢ + Re-ranking** | é«˜ | ä¸­ç­‰ | ç”Ÿäº§ç¯å¢ƒï¼Œå¯¹ç²¾åº¦è¦æ±‚é«˜ |

> ğŸ’¡ **å®æˆ˜æç¤º**ï¼š
> * **æ£€ç´¢é˜¶æ®µ**ï¼šç”¨å‘é‡æ£€ç´¢å¿«é€Ÿç­›é€‰ï¼ˆTop 20-50ï¼‰
> * **é‡æ’é˜¶æ®µ**ï¼šç”¨ Cross-Encoder ç²¾ç¡®æ’åºï¼ˆTop 5-10ï¼‰
> * **å¹³è¡¡ç‚¹**ï¼šåœ¨ç²¾åº¦å’Œé€Ÿåº¦ä¹‹é—´æ‰¾åˆ°å¹³è¡¡

### 3.2 Query Transformationï¼ˆæŸ¥è¯¢è½¬æ¢ï¼‰ï¼šæå‡å¬å›ç‡

ç”¨æˆ·é—®"è¿™ä¸ªåŠŸèƒ½æ€ä¹ˆç”¨ï¼Ÿ"â€”â€”**å‘é‡åº“ä¸çŸ¥é“"è¿™ä¸ª"æŒ‡ä»€ä¹ˆ**ã€‚æˆ–è€…åªè¾“å…¥"ç™»å½•"ï¼Œå¤ªçŸ­ï¼Œå¬å›ä¸å…¨ã€‚

**æŸ¥è¯¢è½¬æ¢**ç”¨ LLM æŠŠæ¨¡ç³Šã€ä¾èµ–ä¸Šä¸‹æ–‡çš„æŸ¥è¯¢æ”¹å†™æˆç‹¬ç«‹å®Œæ•´çš„å¥å­ï¼Œæå‡å¬å›ç‡ã€‚

#### æŸ¥è¯¢é‡å†™ï¼ˆQuery Rewritingï¼‰

**åœºæ™¯**ï¼šç”¨æˆ·é—®"è¿™ä¸ªåŠŸèƒ½æ€ä¹ˆç”¨ï¼Ÿ"ï¼Œéœ€è¦ç»“åˆå†å²å¯¹è¯æ‰çŸ¥é“"è¿™ä¸ª"æŒ‡ç™»å½•åŠŸèƒ½

**æ–¹æ³•**ï¼šä½¿ç”¨ LLM å°†ä¾èµ–ä¸Šä¸‹æ–‡çš„æŸ¥è¯¢è½¬ä¸ºç‹¬ç«‹å®Œæ•´çš„å¥å­ã€‚

**ç¤ºä¾‹**ï¼š
```python
# æŸ¥è¯¢é‡å†™ï¼ˆä¼ªä»£ç ï¼‰

# åŸå§‹æŸ¥è¯¢ï¼ˆä¾èµ–ä¸Šä¸‹æ–‡ï¼‰
user_query = "è¿™ä¸ªåŠŸèƒ½æ€ä¹ˆç”¨ï¼Ÿ"
conversation_history = [
    "ç”¨æˆ·ï¼šæˆ‘æƒ³äº†è§£ç”¨æˆ·ç™»å½•åŠŸèƒ½",
    "åŠ©æ‰‹ï¼šç”¨æˆ·ç™»å½•åŠŸèƒ½æ”¯æŒé‚®ç®±å’Œæ‰‹æœºå·ç™»å½•..."
]

# ä½¿ç”¨ LLM é‡å†™æŸ¥è¯¢
rewritten_query = llm.generate(f"""
è¯·å°†ä»¥ä¸‹æŸ¥è¯¢æ”¹å†™ä¸ºç‹¬ç«‹å®Œæ•´çš„å¥å­ï¼Œä¸ä¾èµ–ä¸Šä¸‹æ–‡ï¼š

å†å²å¯¹è¯ï¼š
{conversation_history}

å½“å‰æŸ¥è¯¢ï¼š{user_query}

æ”¹å†™åçš„æŸ¥è¯¢ï¼š
""")

# è¾“å‡ºï¼šç”¨æˆ·ç™»å½•åŠŸèƒ½æ€ä¹ˆç”¨ï¼Ÿ
```

#### æŸ¥è¯¢æ‰©å±•ï¼ˆQuery Expansion / RAG-Fusionï¼‰

**åœºæ™¯**ï¼šç”¨æˆ·æŸ¥è¯¢ç®€çŸ­ï¼Œå¯èƒ½é—æ¼ç›¸å…³å…³é”®è¯ã€‚

**æ–¹æ³•**ï¼šæ·»åŠ åŒä¹‰è¯æˆ–ç›¸å…³å…³é”®è¯ï¼Œç”Ÿæˆå¤šä¸ªæŸ¥è¯¢ç‰ˆæœ¬ï¼Œåˆ†åˆ«æ£€ç´¢ååˆå¹¶ç»“æœã€‚

**ç¤ºä¾‹**ï¼š
```python
# æŸ¥è¯¢æ‰©å±•ï¼ˆä¼ªä»£ç ï¼‰

# åŸå§‹æŸ¥è¯¢
user_query = "ç™»å½•"

# ä½¿ç”¨ LLM æ‰©å±•æŸ¥è¯¢
expanded_queries = llm.generate(f"""
è¯·ä¸ºä»¥ä¸‹æŸ¥è¯¢ç”Ÿæˆ3ä¸ªç›¸å…³çš„æŸ¥è¯¢å˜ä½“ï¼š

åŸå§‹æŸ¥è¯¢ï¼š{user_query}

æŸ¥è¯¢å˜ä½“ï¼š
1. 
2. 
3. 
""")

# è¾“å‡ºï¼š
# 1. ç”¨æˆ·ç™»å½•
# 2. è´¦å·ç™»å½•
# 3. ç™»å½•éªŒè¯

# åˆ†åˆ«æ£€ç´¢æ¯ä¸ªæŸ¥è¯¢
all_results = []
for query in [user_query] + expanded_queries:
    results = vector_db.search(embed(query))
    all_results.extend(results)

# åˆå¹¶å¹¶å»é‡
final_results = merge_and_deduplicate(all_results)
```

**æ•ˆæœå¯¹æ¯”**ï¼š

| æ–¹æ³• | å¬å›ç‡ | è®¡ç®—æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|--------|---------|---------|
| **åŸå§‹æŸ¥è¯¢** | ä½ | ä½ | æŸ¥è¯¢å·²ç»å¾ˆå®Œæ•´ |
| **æŸ¥è¯¢é‡å†™** | ä¸­ | ä¸­ | æŸ¥è¯¢ä¾èµ–ä¸Šä¸‹æ–‡ |
| **æŸ¥è¯¢æ‰©å±•** | é«˜ | é«˜ | æŸ¥è¯¢ç®€çŸ­ï¼Œéœ€è¦é«˜å¬å›ç‡ |

> ğŸ’¡ **å®æˆ˜æç¤º**ï¼š
> * **ç®€å•æŸ¥è¯¢**ï¼šç›´æ¥ä½¿ç”¨åŸå§‹æŸ¥è¯¢
> * **ä¾èµ–ä¸Šä¸‹æ–‡**ï¼šä½¿ç”¨æŸ¥è¯¢é‡å†™
> * **éœ€è¦é«˜å¬å›ç‡**ï¼šä½¿ç”¨æŸ¥è¯¢æ‰©å±•

### 3.3 RAG ä¸ Agent çš„é›†æˆï¼ˆMulti-Hop RAGï¼‰

**åœºæ™¯**ï¼šå¤šæ­¥éª¤æ¨ç†ä»»åŠ¡ï¼Œå•è½® RAG æ— æ³•å›ç­”ï¼Œå¦‚"æ€»ç»“ A æ–‡æ¡£å¯¹ B é¡¹ç›®çš„å½±å“"ã€‚

**æœºåˆ¶**ï¼šAgent å°†å¤æ‚ä»»åŠ¡æ‹†æˆå­é—®é¢˜ï¼Œåˆ†åˆ«è°ƒç”¨ RAG æ£€ç´¢çŸ¥è¯†ï¼Œæ”¶é›† Observation åç»¼åˆç”Ÿæˆæœ€ç»ˆç­”æ¡ˆã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦ Multi-Hop RAGï¼Ÿ

**å•è½® RAG çš„å±€é™**ï¼š
* ä¸€æ¬¡æ£€ç´¢åªèƒ½å›ç­”ä¸€ä¸ªé—®é¢˜
* æ— æ³•å¤„ç†éœ€è¦å¤šæ­¥éª¤æ¨ç†çš„å¤æ‚é—®é¢˜
* æ— æ³•èåˆå¤šä¸ªæ–‡æ¡£çš„çŸ¥è¯†

**Multi-Hop RAG çš„ä¼˜åŠ¿**ï¼š
* æ”¯æŒå¤šæ­¥éª¤æ¨ç†
* å¯ä»¥èåˆå¤šä¸ªæ–‡æ¡£çš„çŸ¥è¯†
* å¯ä»¥å¤„ç†å¤æ‚çš„å†³ç­–ä»»åŠ¡

#### å·¥ä½œåŸç†

```python
# Multi-Hop RAG ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰

# ç”¨æˆ·æŸ¥è¯¢
user_query = "æ€»ç»“ç”¨æˆ·ç™»å½•åŠŸèƒ½æ–‡æ¡£å¯¹æµ‹è¯•å¹³å°é¡¹ç›®çš„å½±å“"

# Agent æ‹†è§£ä»»åŠ¡
sub_questions = agent.plan(user_query)
# è¾“å‡ºï¼š
# 1. ç”¨æˆ·ç™»å½•åŠŸèƒ½æ–‡æ¡£çš„ä¸»è¦å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ
# 2. æµ‹è¯•å¹³å°é¡¹ç›®çš„å½“å‰çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Ÿ
# 3. ç”¨æˆ·ç™»å½•åŠŸèƒ½å¦‚ä½•å½±å“æµ‹è¯•å¹³å°ï¼Ÿ

# å¤šè½®æ£€ç´¢å’Œæ¨ç†
observations = []
for question in sub_questions:
    # æ£€ç´¢ç›¸å…³æ–‡æ¡£
    relevant_docs = rag.retrieve(question)
    
    # ç”Ÿæˆè§‚å¯Ÿç»“æœ
    observation = llm.generate(f"""
    é—®é¢˜ï¼š{question}
    
    ç›¸å…³æ–‡æ¡£ï¼š
    {relevant_docs}
    
    è¯·åŸºäºæ–‡æ¡£å›ç­”è¿™ä¸ªé—®é¢˜ï¼š
    """)
    observations.append(observation)

# ç»¼åˆæ‰€æœ‰è§‚å¯Ÿç»“æœï¼Œç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
final_answer = llm.generate(f"""
åŸå§‹é—®é¢˜ï¼š{user_query}

å­é—®é¢˜å’Œç­”æ¡ˆï¼š
{observations}

è¯·ç»¼åˆä»¥ä¸Šä¿¡æ¯ï¼Œå›ç­”åŸå§‹é—®é¢˜ï¼š
""")
```

#### ä¸ ReAct ç»“åˆ

Multi-Hop RAG å¯ä»¥ä¸ [ReAct æ€ç»´é“¾](/2025-12-04-llm-prompt-engineering-practices/#æŠ€å·§äºŒæ€ç»´é“¾è¿›é˜¶advanced-cot-react)ç»“åˆï¼Œè®© LLM åœ¨æ¯ä¸€æ­¥æ£€ç´¢åéƒ½è¿›è¡Œæ¨ç†ä¸è‡ªæˆ‘ä¿®æ­£ã€‚

**ç¤ºä¾‹**ï¼š
```text
Thought: ç”¨æˆ·é—®çš„æ˜¯"æ€»ç»“ç”¨æˆ·ç™»å½•åŠŸèƒ½æ–‡æ¡£å¯¹æµ‹è¯•å¹³å°é¡¹ç›®çš„å½±å“"ï¼Œè¿™éœ€è¦ï¼š
1. å…ˆæ£€ç´¢ç”¨æˆ·ç™»å½•åŠŸèƒ½æ–‡æ¡£
2. å†æ£€ç´¢æµ‹è¯•å¹³å°é¡¹ç›®æ–‡æ¡£
3. æœ€åç»¼åˆåˆ†æä¸¤è€…çš„å…³ç³»

Action: retrieve(query="ç”¨æˆ·ç™»å½•åŠŸèƒ½æ–‡æ¡£")

Observation: [æ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹]

Thought: ç°åœ¨æˆ‘äº†è§£äº†ç”¨æˆ·ç™»å½•åŠŸèƒ½çš„å†…å®¹ï¼Œæ¥ä¸‹æ¥éœ€è¦æ£€ç´¢æµ‹è¯•å¹³å°é¡¹ç›®çš„ä¿¡æ¯ã€‚

Action: retrieve(query="æµ‹è¯•å¹³å°é¡¹ç›®å½“å‰çŠ¶æ€")

Observation: [æ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹]

Thought: ç°åœ¨æˆ‘æœ‰è¶³å¤Ÿçš„ä¿¡æ¯æ¥å›ç­”é—®é¢˜äº†ã€‚

Final Answer: [ç»¼åˆä¸¤ä¸ªæ–‡æ¡£çš„ä¿¡æ¯ï¼Œç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ]
```

> ğŸ’¡ **å®æˆ˜æç¤º**ï¼š
> * **ç®€å•é—®é¢˜**ï¼šä½¿ç”¨å•è½® RAG
> * **å¤æ‚é—®é¢˜**ï¼šä½¿ç”¨ Multi-Hop RAG
> * **éœ€è¦æ¨ç†**ï¼šç»“åˆ ReAct æ€ç»´é“¾

---

## ğŸ” æ€»ç»“ï¼šRAG çš„å·¥ç¨‹åŒ–ä»·å€¼

RAG å°† LLM ä»"é™æ€ç™¾ç§‘å…¨ä¹¦"å‡çº§ä¸º**åŠ¨æ€çŸ¥è¯†ä¸“å®¶**ï¼Œè§£å†³äº† LLM çš„ä¸¤å¤§æ ¸å¿ƒé—®é¢˜ï¼š

### RAG çš„æ ¸å¿ƒä»·å€¼

| é—®é¢˜ | ä¼ ç»Ÿ LLM | RAG è§£å†³æ–¹æ¡ˆ |
|------|---------|-------------|
| **çŸ¥è¯†æ—¶æ•ˆæ€§** | è®­ç»ƒæ•°æ®æˆªæ­¢åˆ°æŸä¸ªæ—¶é—´ç‚¹ | å®æ—¶è®¿é—®æœ€æ–°ä¿¡æ¯å’Œç§æœ‰æ•°æ® |
| **çŸ¥è¯†èŒƒå›´** | åªèƒ½ä½¿ç”¨è®­ç»ƒæ—¶çš„æ•°æ® | å¯ä»¥è®¿é—®ä¼ä¸šç§æœ‰æ–‡æ¡£ã€å†…éƒ¨çŸ¥è¯†åº“ |
| **å¹»è§‰é—®é¢˜** | å¯èƒ½ç¼–é€ é”™è¯¯ä¿¡æ¯ | ç­”æ¡ˆå¯è¿½æº¯ã€å¯éªŒè¯ï¼Œæœ‰æ®å¯æŸ¥ |
| **ä¸Šä¸‹æ–‡é™åˆ¶** | Context Window æœ‰é™ | é€šè¿‡æ£€ç´¢åªæ³¨å…¥ç›¸å…³æ–‡æ¡£ï¼Œçªç ´é™åˆ¶ |

### æ„å»ºé«˜æ•ˆ RAG ç³»ç»Ÿçš„å…³é”®ç¯èŠ‚

1. **åˆ†å—ï¼ˆChunkingï¼‰**ï¼šä¿è¯è¯­ä¹‰å®Œæ•´æ€§ï¼Œé€‰æ‹©åˆé€‚çš„åˆ†å—ç­–ç•¥
2. **å‘é‡åŒ–ï¼ˆEmbeddingï¼‰**ï¼šé€‰æ‹©åˆé€‚çš„ Embedding æ¨¡å‹ï¼Œç¡®ä¿æ£€ç´¢ç²¾åº¦
3. **ç´¢å¼•ï¼ˆVector Databaseï¼‰**ï¼šé€‰æ‹©é«˜æ€§èƒ½å‘é‡æ•°æ®åº“ï¼Œæ”¯æŒå¤§è§„æ¨¡æ£€ç´¢
4. **åå¤„ç†ï¼ˆRe-rankingã€Query Transformationï¼‰**ï¼šæå‡ç²¾ç¡®ç‡å’Œå¬å›ç‡

### RAG ä¸ Agent çš„ç»“åˆ

RAG ä¸ä»…æ˜¯çŸ¥è¯†æ£€ç´¢å·¥å…·ï¼Œæ›´æ˜¯ Agent çš„"çŸ¥è¯†åº“"ï¼š

* **å•è½® RAG**ï¼šå›ç­”ç®€å•é—®é¢˜ï¼Œæä¾›çŸ¥è¯†æ”¯æŒ
* **Multi-Hop RAG**ï¼šå¤„ç†å¤æ‚æ¨ç†ä»»åŠ¡ï¼Œèåˆå¤šæ–‡æ¡£çŸ¥è¯†
* **RAG + ReAct**ï¼šç»“åˆæ€ç»´é“¾ï¼Œå®ç°å¯æ§çš„çŸ¥è¯†æ£€ç´¢å’Œæ¨ç†

> ğŸ’¡ **æ ¸å¿ƒç†è§£**ï¼šRAG æ˜¯ Agent æ—¶ä»£é«˜å¯ä¿¡åº¦å›ç­”çš„åŸºçŸ³ã€‚æŒæ¡äº† RAGï¼Œä½ å°±æŒæ¡äº†è®© LLM è®¿é—®å¤–éƒ¨çŸ¥è¯†ã€çªç ´çŸ¥è¯†é™åˆ¶çš„å…³é”®æŠ€æœ¯ã€‚

---

## ğŸ“š å»¶ä¼¸é˜…è¯»ï¼ˆå«å¯ç›´æ¥è®¿é—®é“¾æ¥ï¼‰

ä»¥ä¸‹èµ„æºæŒ‰ä¸»é¢˜åˆ†ç±»ï¼Œæ¯ä¸ªèµ„æºéƒ½é™„æœ‰ç®€è¦è¯´æ˜ï¼Œå¸®åŠ©ä½ é€‰æ‹©åˆé€‚çš„å­¦ä¹ ææ–™ã€‚

### ğŸ” RAG ç»¼è¿°ä¸åŸç†

* [**A Survey on Retrieval-Augmented Generationï¼ˆRAG ç»¼è¿°è®ºæ–‡ï¼‰**](https://arxiv.org/abs/2303.07293)ï¼šRAG é¢†åŸŸçš„å…¨é¢ç»¼è¿°ï¼Œæ¶µç›–åŸç†ã€åº”ç”¨å’Œæœ€æ–°è¿›å±•ã€‚**å¿…è¯»è®ºæ–‡**ï¼Œé€‚åˆæƒ³ç³»ç»Ÿäº†è§£ RAG çš„è¯»è€…ã€‚

* [**Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasksï¼ˆRAG åŸå§‹è®ºæ–‡ï¼‰**](https://arxiv.org/abs/2005.11401)ï¼šRAG çš„å¼€åˆ›æ€§è®ºæ–‡ï¼Œé¦–æ¬¡æå‡º RAG æ¶æ„ã€‚**å¿…è¯»è®ºæ–‡**ï¼Œé€‚åˆæƒ³ç†è§£ RAG åŸç†çš„è¯»è€…ã€‚

* [**RAG æŠ€æœ¯è¯¦è§£ï¼ˆä¸­æ–‡åšå®¢ï¼‰**](https://lilianweng.github.io/posts/2023-06-30-rag/)ï¼šLilian Weng çš„ RAG æŠ€æœ¯è¯¦è§£ï¼Œæœ‰ä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬ã€‚é€‚åˆä¸­æ–‡è¯»è€…ï¼Œå†…å®¹æ·±å…¥ã€‚

### ğŸ§± Chunkingï¼ˆåˆ†å—ï¼‰

* [**LangChain æ–‡æ¡£ â€” Text Splitterï¼ˆæ–‡æœ¬åˆ†å‰²å™¨ï¼‰**](https://www.langchain.com/docs/modules/data_connection/text_splitters/)ï¼šLangChain çš„æ–‡æœ¬åˆ†å‰²å™¨æ–‡æ¡£ï¼ŒåŒ…å«å¤šç§åˆ†å—ç­–ç•¥ã€‚**å¼ºçƒˆæ¨è**ï¼Œé€‚åˆéœ€è¦å®ç°åˆ†å—çš„å¼€å‘è€…ã€‚

* [**Semantic Chunkingï¼ˆè¯­ä¹‰åˆ†å—ï¼‰**](https://www.pinecone.io/learn/chunking-strategies/)ï¼šPinecone çš„è¯­ä¹‰åˆ†å—æŒ‡å—ï¼ŒåŒ…å«å®æˆ˜ç¤ºä¾‹ã€‚é€‚åˆæƒ³æ·±å…¥äº†è§£è¯­ä¹‰åˆ†å—çš„è¯»è€…ã€‚

* [**Parent-Document Retrieverï¼ˆçˆ¶æ–‡æ¡£æ£€ç´¢å™¨ï¼‰**](https://python.langchain.com/docs/modules/data_retrievers/parent_document_retriever/)ï¼šLangChain çš„çˆ¶æ–‡æ¡£æ£€ç´¢å™¨å®ç°ã€‚é€‚åˆéœ€è¦å®ç°çˆ¶æ–‡æ¡£ç­–ç•¥çš„å¼€å‘è€…ã€‚

### ğŸ”¢ Embeddingï¼ˆåµŒå…¥ï¼‰

* [**Sentence Transformers å®˜æ–¹æ–‡æ¡£**](https://www.sbert.net/)ï¼šSentence Transformers çš„å®˜æ–¹æ–‡æ¡£ï¼ŒåŒ…å«æ¨¡å‹åˆ—è¡¨å’Œä½¿ç”¨æŒ‡å—ã€‚**å¼ºçƒˆæ¨è**ï¼Œé€‚åˆéœ€è¦é€‰æ‹© Embedding æ¨¡å‹çš„å¼€å‘è€…ã€‚

* [**MTEB: Massive Text Embedding Benchmarkï¼ˆEmbedding æ¨¡å‹æ’è¡Œæ¦œï¼‰**](https://huggingface.co/spaces/mteb/leaderboard)ï¼šEmbedding æ¨¡å‹çš„æ€§èƒ½æ’è¡Œæ¦œã€‚é€‚åˆéœ€è¦é€‰æ‹©æœ€ä½³æ¨¡å‹çš„å¼€å‘è€…ã€‚

* [**ä¸­æ–‡ Embedding æ¨¡å‹æ¨è**](https://github.com/FlagOpen/FlagEmbedding)ï¼šFlagEmbedding é¡¹ç›®ï¼ŒåŒ…å«å¤šä¸ªä¸­æ–‡ Embedding æ¨¡å‹ã€‚é€‚åˆä¸­æ–‡åœºæ™¯çš„å¼€å‘è€…ã€‚

### ğŸ—„ï¸ Vector Databaseï¼ˆå‘é‡æ•°æ®åº“ï¼‰

* [**Pinecone å®˜æ–¹æ–‡æ¡£**](https://docs.pinecone.io/)ï¼šPinecone çš„å®˜æ–¹æ–‡æ¡£ï¼ŒåŒ…å«å¿«é€Ÿå…¥é—¨å’Œæœ€ä½³å®è·µã€‚é€‚åˆä½¿ç”¨ Pinecone çš„å¼€å‘è€…ã€‚

* [**Milvus å®˜æ–¹æ–‡æ¡£**](https://milvus.io/docs)ï¼šMilvus çš„å®˜æ–¹æ–‡æ¡£ï¼ŒåŒ…å«éƒ¨ç½²å’Œä½¿ç”¨æŒ‡å—ã€‚é€‚åˆéœ€è¦è‡ªéƒ¨ç½²å‘é‡æ•°æ®åº“çš„å¼€å‘è€…ã€‚

* [**Weaviate å®˜æ–¹æ–‡æ¡£**](https://weaviate.io/developers/weaviate)ï¼šWeaviate çš„å®˜æ–¹æ–‡æ¡£ï¼ŒåŒ…å«å¤šæ¨¡æ€æ£€ç´¢åŠŸèƒ½ã€‚é€‚åˆéœ€è¦å¤æ‚æŸ¥è¯¢çš„å¼€å‘è€…ã€‚

* [**HNSW Algorithm Explainedï¼ˆHNSW ç®—æ³•è¯¦è§£ï¼‰**](https://arxiv.org/abs/1603.09320)ï¼šHNSW ç´¢å¼•ç®—æ³•çš„åŸå§‹è®ºæ–‡ã€‚é€‚åˆæƒ³ç†è§£å‘é‡æ£€ç´¢åŸç†çš„è¯»è€…ã€‚

### ğŸš€ è¿›é˜¶ä¼˜åŒ–

* [**LlamaIndex å®˜æ–¹æ•™ç¨‹**](https://docs.llamaindex.ai/)ï¼šLlamaIndex çš„å®˜æ–¹æ•™ç¨‹ï¼ŒåŒ…å« Query Rewritingã€RAG-Fusion ç­‰è¿›é˜¶æŠ€å·§ã€‚**å¼ºçƒˆæ¨è**ï¼Œé€‚åˆæƒ³æ·±å…¥å­¦ä¹  RAG çš„å¼€å‘è€…ã€‚

* [**Re-ranking with Cross-Encodersï¼ˆé‡æ’åºï¼‰**](https://www.sbert.net/examples/applications/cross-encoder/README.html)ï¼šSentence Transformers çš„ Cross-Encoder ä½¿ç”¨æŒ‡å—ã€‚é€‚åˆéœ€è¦å®ç° Re-ranking çš„å¼€å‘è€…ã€‚

* [**Multi-Hop RAGï¼ˆå¤šè·³æ£€ç´¢ï¼‰**](https://docs.llamaindex.ai/en/stable/examples/query_engine/sub_question_query_engine.html)ï¼šLlamaIndex çš„å¤šè·³æ£€ç´¢å®ç°ã€‚é€‚åˆéœ€è¦å¤„ç†å¤æ‚æŸ¥è¯¢çš„å¼€å‘è€…ã€‚

### ğŸ› ï¸ å®æˆ˜æ¡†æ¶

* [**LangChain RAG æ•™ç¨‹**](https://python.langchain.com/docs/use_cases/question_answering/)ï¼šLangChain çš„ RAG å®æˆ˜æ•™ç¨‹ï¼ŒåŒ…å«å®Œæ•´ç¤ºä¾‹ã€‚**å¼ºçƒˆæ¨è**ï¼Œé€‚åˆæƒ³å¿«é€Ÿä¸Šæ‰‹çš„å¼€å‘è€…ã€‚

* [**LlamaIndex RAG æ•™ç¨‹**](https://docs.llamaindex.ai/en/stable/getting_started/concepts.html)ï¼šLlamaIndex çš„ RAG æ•™ç¨‹ï¼ŒåŒ…å«å¤šç§æ£€ç´¢ç­–ç•¥ã€‚é€‚åˆæƒ³ç³»ç»Ÿå­¦ä¹ çš„å¼€å‘è€…ã€‚

* [**Haystack RAG æ•™ç¨‹**](https://haystack.deepset.ai/tutorials/01_basic_qa_pipeline)ï¼šHaystack çš„ RAG æ•™ç¨‹ï¼ŒåŒ…å«å®Œæ•´æµç¨‹ã€‚é€‚åˆä½¿ç”¨ Haystack çš„å¼€å‘è€…ã€‚

---

## ğŸ”” ç³»åˆ—è¯´æ˜

> æœ¬æ–‡æ˜¯[ã€ŠğŸ§  LLM/Agent ä»å…¥é—¨åˆ°ç²¾é€šï¼šå‘Šåˆ«æµ…å°è¾„æ­¢ã€‹](/categories/ğŸ§ -LLM-Agent-ä»å…¥é—¨åˆ°ç²¾é€šï¼šå‘Šåˆ«æµ…å°è¾„æ­¢/)ç³»åˆ—ç¬¬ 4 ç¯‡ã€‚ä¸Šä¸€ç¯‡ï¼š[æƒ³è¦ JSON å´å¾—åˆ°åºŸè¯ï¼ŸPrompt å·¥ç¨‹çš„ä¸‰å¤§æ ¸å¿ƒæŠ€å·§](/2025-12-04-llm-prompt-engineering-practices/)ã€‚ä¸‹ä¸€ç¯‡ï¼š[GPT-4ã€Claudeã€Llama æ€ä¹ˆé€‰ï¼Ÿæ¨¡å‹é€‰å‹é¿å‘æŒ‡å—](/2025-12-09-llm-model-evaluation-selection/) â€”â€” å‚æ•°é‡ã€æ¨ç†é€Ÿåº¦ã€æˆæœ¬å¦‚ä½•æƒè¡¡ï¼Ÿ

